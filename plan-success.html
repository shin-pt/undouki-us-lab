<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éó„É©„É≥ÁôªÈå≤ÂÆå‰∫Ü - ÈÅãÂãïÂô®Ë∂ÖÈü≥Ê≥¢Lab</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 600px;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 50px 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .success-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            animation: scaleIn 0.5s ease-out;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
            }
            to {
                transform: scale(1);
            }
        }

        .success-icon i {
            font-size: 3rem;
            color: #fff;
        }

        h1 {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 20px;
            color: #fff;
        }

        .plan-badge {
            display: inline-block;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: 700;
            margin: 20px 0;
        }

        .plan-badge.basic {
            background: rgba(0, 123, 255, 0.2);
            color: #66b2ff;
        }

        .plan-badge.premium {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        p {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 30px;
            color: #ccc;
        }

        .btn {
            display: inline-block;
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            color: #e57373;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loadingSection" class="loading">
            <div class="spinner"></div>
            <p>„Éó„É©„É≥ÁôªÈå≤„ÇíÂá¶ÁêÜ‰∏≠...</p>
        </div>

        <div id="successSection" style="display: none;">
            <div class="success-icon">
                <i class="fas fa-check"></i>
            </div>
            <h1>„Éó„É©„É≥ÁôªÈå≤„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ</h1>
            <div id="planBadge" class="plan-badge"></div>
            <p id="successMessage"></p>
            <a href="salon.html" class="btn">
                <i class="fas fa-users"></i> „Ç™„É≥„É©„Ç§„É≥„Çµ„É≠„É≥„Å∏
            </a>
            <a href="member.html" class="btn" style="background: rgba(255, 255, 255, 0.1);">
                <i class="fas fa-user"></i> „Éû„Ç§„Éö„Éº„Ç∏„Å∏
            </a>
        </div>

        <div id="errorSection" style="display: none;">
            <div class="error-message">
                <h2><i class="fas fa-exclamation-circle"></i> „Ç®„É©„Éº</h2>
                <p id="errorMessage"></p>
            </div>
            <a href="plans.html" class="btn">
                <i class="fas fa-arrow-left"></i> „Éó„É©„É≥„Éö„Éº„Ç∏„Å´Êàª„Çã
            </a>
        </div>
    </div>

    <!-- Stripe Payment LinksË®≠ÂÆö -->
    <script src="plan-payment-config.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            doc,
            updateDoc,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyAGKikNortFcMI_uLnGn2y_OyI6ZyxLiR0",
            authDomain: "musculoskeletal-us-lab.firebaseapp.com",
            projectId: "musculoskeletal-us-lab",
            storageBucket: "musculoskeletal-us-lab.firebasestorage.app",
            messagingSenderId: "199172067938",
            appId: "1:199172067938:web:cdbcf04400cc74a784b73b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loadingSection = document.getElementById('loadingSection');
        const successSection = document.getElementById('successSection');
        const errorSection = document.getElementById('errorSection');
        const planBadge = document.getElementById('planBadge');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');

        // „Éó„É©„É≥ÁôªÈå≤„ÇíÂá¶ÁêÜ
        async function processPlanRegistration() {
            const user = auth.currentUser;
            if (!user) {
                showError('„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
                return;
            }

            // ‰øùÁïô‰∏≠„ÅÆ„Éó„É©„É≥ÁôªÈå≤ÊÉÖÂ†±„ÇíÂèñÂæóÔºàLocalStorage„Åã„ÇâÔºâ
            let pendingRegistration = null;
            try {
                const planId = localStorage.getItem('pending_plan_registration');
                const userId = localStorage.getItem('pending_plan_user_id');
                const userEmail = localStorage.getItem('pending_plan_user_email');
                
                console.log('üìù Checking LocalStorage:', { planId, userId, currentUserId: user.uid });
                
                if (planId && userId && userId === user.uid) {
                    pendingRegistration = {
                        planId: planId,
                        userId: userId,
                        userEmail: userEmail
                    };
                    console.log('‚úÖ Found pending registration in LocalStorage:', pendingRegistration);
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Failed to get pending plan registration from localStorage:', e);
            }

            // LocalStorage„Å´ÊÉÖÂ†±„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅURL„Éë„É©„É°„Éº„Çø„Åã„ÇâÂèñÂæóÔºàStripe„Åã„Çâ„ÅÆ„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÊôÇÔºâ
            if (!pendingRegistration) {
                const urlParams = new URLSearchParams(window.location.search);
                const planId = urlParams.get('plan') || urlParams.get('plan_id');
                
                console.log('üìù Checking URL parameters:', { plan: planId });
                
                if (planId && (planId === 'basic' || planId === 'premium')) {
                    pendingRegistration = {
                        planId: planId,
                        userId: user.uid,
                        userEmail: user.email
                    };
                    console.log('‚úÖ Found plan from URL parameters:', pendingRegistration);
                } else {
                    // LocalStorage„Å´„ÇÇURL„Éë„É©„É°„Éº„Çø„Å´„ÇÇÊÉÖÂ†±„Åå„Å™„ÅÑÂ†¥Âêà
                    // ÊâãÂãï„Åß„Éó„É©„É≥„ÇíÈÅ∏Êäû„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã
                    showError('„Éó„É©„É≥ÁôªÈå≤ÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\n\n„Éó„É©„É≥„Éö„Éº„Ç∏„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ\n„Åæ„Åü„ÅØ„ÄÅ„Éñ„É©„Ç¶„Ç∂„ÅÆ„Ç≥„É≥„ÇΩ„Éº„É´ÔºàF12Ôºâ„ÅßÊâãÂãï„Åß„Éó„É©„É≥„ÇíË®≠ÂÆö„Åô„Çã„Åì„Å®„ÇÇ„Åß„Åç„Åæ„Åô„ÄÇ');
                    console.log('üí° Manual plan setting available in console');
                    console.log('üí° Example: localStorage.setItem("pending_plan_registration", "basic"); location.reload();');
                    return;
                }
            }

            // „É¶„Éº„Ç∂„ÉºID„Åå‰∏ÄËá¥„Åô„Çã„ÅãÁ¢∫Ë™ç
            if (pendingRegistration.userId !== user.uid) {
                showError('„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì„ÄÇ');
                return;
            }

            try {
                // Firestore„Å´„Éó„É©„É≥ÊÉÖÂ†±„Çí‰øùÂ≠ò
                const userRef = doc(db, 'users', user.uid);
                await updateDoc(userRef, {
                    plan: pendingRegistration.planId,
                    planStartDate: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });

                // ÊàêÂäüÁîªÈù¢„ÇíË°®Á§∫
                const planName = pendingRegistration.planId === 'basic' ? '1980ÂÜÜ„Éó„É©„É≥' : '2980ÂÜÜ„Éó„É©„É≥';
                planBadge.className = `plan-badge ${pendingRegistration.planId}`;
                planBadge.textContent = planName;
                successMessage.textContent = `${planName}„Å∏„ÅÆÁôªÈå≤„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ\n„Ç™„É≥„É©„Ç§„É≥„Çµ„É≠„É≥„Åß„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí„ÅäÊ•Ω„Åó„Åø„Åè„Å†„Åï„ÅÑ„ÄÇ`;

                loadingSection.style.display = 'none';
                successSection.style.display = 'block';

                // ‰øùÁïô‰∏≠„ÅÆÁôªÈå≤ÊÉÖÂ†±„Çí„ÇØ„É™„Ç¢
                if (typeof clearPendingPlanRegistration === 'function') {
                    clearPendingPlanRegistration();
                }
            } catch (error) {
                console.error('„Éó„É©„É≥ÁôªÈå≤„Ç®„É©„Éº:', error);
                showError('„Éó„É©„É≥„ÅÆÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            loadingSection.style.display = 'none';
            errorSection.style.display = 'block';
        }

        // Ë™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await processPlanRegistration();
            } else {
                showError('„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà„Åó„Åæ„Åô„ÄÇ');
                setTimeout(() => {
                    window.location.href = 'auth.html';
                }, 3000);
            }
        });
    </script>
</body>
</html>

