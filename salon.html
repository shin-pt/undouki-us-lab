<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚µãƒ­ãƒ³ - é‹å‹•å™¨è¶…éŸ³æ³¢Lab</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', 'Poppins', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1140px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-section h1 {
            font-size: 1.8rem;
            color: #e0e0e0;
            font-weight: 700;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-links a {
            color: #e0e0e0;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .nav-links a:hover {
            color: #007bff;
        }

        .salon-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 50px 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-title {
            font-size: 2.5rem;
            margin-bottom: 40px;
            text-align: center;
            background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .category-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            color: #999;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .category-tab.active {
            color: #007bff;
        }

        .category-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #007bff;
        }

        .category-tab:hover {
            color: #007bff;
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .content-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .content-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 123, 255, 0.2);
        }

        .content-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .content-card-icon {
            font-size: 1.5rem;
            color: #007bff;
        }

        .content-card-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #e0e0e0;
            margin: 0;
        }

        .content-card-description {
            color: #999;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .content-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #666;
        }

        .content-empty {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .content-empty i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #666;
        }

        .content-empty p {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .video-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .video-modal.active {
            display: flex;
        }

        .video-modal-content {
            max-width: 1200px;
            width: 100%;
            position: relative;
        }

        .video-modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #e0e0e0;
            font-size: 2rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .video-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            border-radius: 12px;
            overflow: hidden;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        @media (max-width: 768px) {
            .salon-container {
                padding: 30px 20px;
            }

            .page-title {
                font-size: 2rem;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .nav-links {
                width: 100%;
                justify-content: space-between;
            }

            .content-grid {
                grid-template-columns: 1fr;
            }

            .category-tabs {
                flex-direction: column;
            }

            .category-tab {
                width: 100%;
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="logo-section">
                    <h1>é‹å‹•å™¨è¶…éŸ³æ³¢Lab</h1>
                </div>
                <nav class="nav-links">
                    <a href="index.html"><i class="fas fa-home"></i> ãƒ›ãƒ¼ãƒ </a>
                    <a href="member.html"><i class="fas fa-user"></i> ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
                    <a href="echo-videos.html"><i class="fas fa-video"></i> ã‚¨ã‚³ãƒ¼å‹•ç”»</a>
                    <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
                </nav>
            </div>
        </div>

        <!-- Salon Content -->
        <div class="salon-container">
            <h1 class="page-title">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚µãƒ­ãƒ³</h1>

            <!-- ãƒ—ãƒ©ãƒ³æƒ…å ±è¡¨ç¤º -->
            <div id="planInfoSection" style="display: none; background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 20px; margin-bottom: 30px; border: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h3 style="font-size: 1.2rem; margin-bottom: 8px; color: #e0e0e0;">
                            <i class="fas fa-crown" style="color: #ffc107; margin-right: 8px;"></i>
                            ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³: <span id="currentPlanDisplay">æœªç™»éŒ²</span>
                        </h3>
                        <p style="color: #999; font-size: 0.9rem; margin: 0;">
                            <span id="planDescription">ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²ã™ã‚‹ã¨ã€ã‚ˆã‚Šå¤šãã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™</span>
                        </p>
                    </div>
                    <a href="plans.html" class="btn btn-primary" id="planManageBtn" style="display: none;">
                        <i class="fas fa-crown"></i> ãƒ—ãƒ©ãƒ³ã‚’ç®¡ç†
                    </a>
                </div>
            </div>

            <div id="loadingSection" class="loading">
                <div class="spinner"></div>
                <p>èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>

            <div id="contentSection" style="display: none;">
                <!-- ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ– -->
                <div class="category-tabs">
                    <button class="category-tab active" data-category="all">
                        <i class="fas fa-th"></i> ã™ã¹ã¦
                    </button>
                    <button class="category-tab" data-category="ã‚¨ã‚³ãƒ¼å‹•ç”»">
                        <i class="fas fa-video"></i> ã‚¨ã‚³ãƒ¼å‹•ç”»
                    </button>
                    <button class="category-tab" data-category="PDFè³‡æ–™">
                        <i class="fas fa-file-pdf"></i> PDFè³‡æ–™
                    </button>
                    <button class="category-tab" data-category="ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‹•ç”»">
                        <i class="fas fa-archive"></i> ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‹•ç”»
                    </button>
                    <button class="category-tab" data-category="ã‚¨ã‚³ãƒ¼ã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª">
                        <i class="fas fa-brain"></i> ã‚¨ã‚³ãƒ¼ã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª
                    </button>
                </div>

                <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="content-grid" id="contentGrid">
                    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>
    </div>

    <!-- å‹•ç”»ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="video-modal" id="videoModal">
        <div class="video-modal-content">
            <button class="video-modal-close" id="closeVideoModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="video-container" id="videoContainer">
                <!-- å‹•ç”»ãŒã“ã“ã«åŸ‹ã‚è¾¼ã¾ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>

    <!-- Vimeo Mapping -->
    <script src="vimeo-mapping.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            getDocs, 
            orderBy,
            doc,
            getDoc
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyAGKikNortFcMI_uLnGn2y_OyI6ZyxLiR0",
            authDomain: "musculoskeletal-us-lab.firebaseapp.com",
            projectId: "musculoskeletal-us-lab",
            storageBucket: "musculoskeletal-us-lab.firebasestorage.app",
            messagingSenderId: "199172067938",
            appId: "1:199172067938:web:cdbcf04400cc74a784b73b"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UIè¦ç´ 
        const loadingSection = document.getElementById('loadingSection');
        const contentSection = document.getElementById('contentSection');
        const contentGrid = document.getElementById('contentGrid');
        const logoutBtn = document.getElementById('logoutBtn');
        const categoryTabs = document.querySelectorAll('.category-tab');
        const videoModal = document.getElementById('videoModal');
        const videoContainer = document.getElementById('videoContainer');
        const closeVideoModal = document.getElementById('closeVideoModal');
        const planInfoSection = document.getElementById('planInfoSection');
        const currentPlanDisplay = document.getElementById('currentPlanDisplay');
        const planDescription = document.getElementById('planDescription');
        const planManageBtn = document.getElementById('planManageBtn');

        let allContent = [];
        let currentCategory = 'all';
        let userPlan = null; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ãƒ³æƒ…å ±

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’å–å¾—
        async function getUserPlan(user) {
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    return userData.plan || null;
                }
                return null;
            } catch (error) {
                console.error('ãƒ—ãƒ©ãƒ³æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }

        // ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
        function displayPlanInfo() {
            planInfoSection.style.display = 'block';
            
            if (!userPlan) {
                currentPlanDisplay.textContent = 'æœªç™»éŒ²';
                currentPlanDisplay.style.color = '#999';
                planDescription.textContent = 'ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²ã™ã‚‹ã¨ã€ã‚ˆã‚Šå¤šãã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™';
                planManageBtn.textContent = 'ãƒ—ãƒ©ãƒ³ã‚’ç™»éŒ²ã™ã‚‹';
                planManageBtn.style.display = 'inline-flex';
            } else if (userPlan === 'basic') {
                currentPlanDisplay.textContent = '1980å††ãƒ—ãƒ©ãƒ³';
                currentPlanDisplay.style.color = '#66b2ff';
                planDescription.textContent = 'ã‚¨ã‚³ãƒ¼ã‚¢ãƒ—ãƒªã€Noteè¨˜äº‹ã€ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‹•ç”»ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½';
                planManageBtn.textContent = 'ãƒ—ãƒ©ãƒ³ã‚’å¤‰æ›´ã™ã‚‹';
                planManageBtn.style.display = 'inline-flex';
            } else if (userPlan === 'premium') {
                currentPlanDisplay.textContent = '2980å††ãƒ—ãƒ©ãƒ³';
                currentPlanDisplay.style.color = '#ffc107';
                planDescription.textContent = 'ã™ã¹ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½';
                planManageBtn.textContent = 'ãƒ—ãƒ©ãƒ³ã‚’ç®¡ç†ã™ã‚‹';
                planManageBtn.style.display = 'inline-flex';
            }
        }

        // ãƒ—ãƒ©ãƒ³ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        function canAccessContent(contentRequiredPlan) {
            if (!contentRequiredPlan) return true; // ãƒ—ãƒ©ãƒ³åˆ¶é™ãªã—
            
            if (contentRequiredPlan === 'basic') {
                return userPlan === 'basic' || userPlan === 'premium';
            }
            
            if (contentRequiredPlan === 'premium') {
                return userPlan === 'premium';
            }
            
            return false;
        }

        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆ
                try {
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’å–å¾—
                    userPlan = await getUserPlan(user);
                    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ãƒ³:', userPlan);
                    
                    // ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
                    displayPlanInfo();
                    
                    await loadContent();
                    loadingSection.style.display = 'none';
                    contentSection.style.display = 'block';
                } catch (error) {
                    console.error('ã‚³ãƒ³ãƒ†ãƒ³ãƒ„èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    loadingSection.innerHTML = `
                        <div class="spinner"></div>
                        <p>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p>
                        <p style="font-size: 0.9rem; margin-top: 10px; color: #999;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                    `;
                }
            } else {
                // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                window.location.href = 'auth.html';
            }
        });

        // Firestoreã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—
        async function loadContent() {
            try {
                const contentQuery = query(
                    collection(db, 'salon_content'),
                    where('isActive', '==', true),
                    orderBy('order', 'asc'),
                    orderBy('publishedAt', 'desc')
                );

                const querySnapshot = await getDocs(contentQuery);
                allContent = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allContent.push({
                        id: doc.id,
                        type: data.type || 'video',
                        title: data.title || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—',
                        description: data.description || '',
                        category: data.category || 'ãã®ä»–',
                        url: data.url || '',
                        thumbnail: data.thumbnail || '',
                        requiredPlan: data.requiredPlan || null, // ãƒ—ãƒ©ãƒ³åˆ¶é™
                        publishedAt: data.publishedAt ? data.publishedAt.toDate() : null
                    });
                });

                displayContent();
            } catch (error) {
                console.error('ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¿…è¦ãªå ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                if (error.message.includes('index')) {
                    contentGrid.innerHTML = `
                        <div class="content-empty">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­å®šãŒå¿…è¦ã§ã™</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">
                                ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¦ãã ã•ã„
                            </p>
                        </div>
                    `;
                } else {
                    throw error;
                }
            }
        }

        // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰å‹•ç”»IDã‚’æ¤œç´¢ã™ã‚‹é–¢æ•°
        function findVideoIdByTitle(title) {
            if (typeof VIDEO_TITLES === 'undefined') {
                console.warn('âš ï¸ VIDEO_TITLES is not defined');
                return null;
            }
            
            // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ãƒ—ãƒ©ãƒ³ãƒãƒƒã‚¸ã‚„ãã®ä»–ã®HTMLã‚¿ã‚°ã‚’é™¤å»
            const cleanTitle = title.replace(/<[^>]*>/g, '').trim();
            
            console.log('ğŸ” Searching for video ID with title:', cleanTitle);
            console.log('ğŸ“‹ Available VIDEO_TITLES:', Object.keys(VIDEO_TITLES).length, 'videos');
            
            // VIDEO_TITLESã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ãŒä¸€è‡´ã™ã‚‹å‹•ç”»IDã‚’æ¤œç´¢
            for (const [videoId, videoTitle] of Object.entries(VIDEO_TITLES)) {
                // å®Œå…¨ä¸€è‡´
                if (videoTitle === cleanTitle) {
                    console.log(`âœ… Exact match found: ${videoId} -> ${videoTitle}`);
                    return videoId;
                }
                // éƒ¨åˆ†ä¸€è‡´ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã«å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«ãŒå«ã¾ã‚Œã‚‹ï¼‰
                if (cleanTitle.includes(videoTitle)) {
                    console.log(`âœ… Partial match found: ${videoId} -> ${videoTitle}`);
                    return videoId;
                }
                // é€†æ–¹å‘ã®éƒ¨åˆ†ä¸€è‡´ï¼ˆå‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚¿ã‚¤ãƒˆãƒ«ãŒå«ã¾ã‚Œã‚‹ï¼‰
                if (videoTitle.includes(cleanTitle)) {
                    console.log(`âœ… Reverse partial match found: ${videoId} -> ${videoTitle}`);
                    return videoId;
                }
            }
            
            console.warn(`âš ï¸ No match found for title: "${cleanTitle}"`);
            return null;
        }

        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
        function displayContent() {
            // ã‚«ãƒ†ã‚´ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredContent = currentCategory === 'all' 
                ? allContent 
                : allContent.filter(item => item.category === currentCategory);

            // ãƒ—ãƒ©ãƒ³ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã¿è¡¨ç¤ºï¼‰
            filteredContent = filteredContent.filter(item => canAccessContent(item.requiredPlan));

            if (filteredContent.length === 0) {
                // ãƒ—ãƒ©ãƒ³åˆ¶é™ã§è¦‹ã‚Œãªã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const restrictedContent = currentCategory === 'all' 
                    ? allContent.filter(item => !canAccessContent(item.requiredPlan))
                    : allContent.filter(item => 
                        item.category === currentCategory && !canAccessContent(item.requiredPlan)
                    );

                if (restrictedContent.length > 0) {
                    // ãƒ—ãƒ©ãƒ³åˆ¶é™ã§è¦‹ã‚Œãªã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚ã‚‹å ´åˆ
                    const requiredPlan = restrictedContent[0].requiredPlan;
                    contentGrid.innerHTML = `
                        <div class="content-empty">
                            <i class="fas fa-lock" style="font-size: 3rem; color: #666; margin-bottom: 15px;"></i>
                            <p>ã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ãƒ—ãƒ©ãƒ³ç™»éŒ²ãŒå¿…è¦ã§ã™</p>
                            <p style="font-size: 0.9rem; margin-top: 10px; color: #999;">
                                ${requiredPlan === 'basic' ? '1980å††ãƒ—ãƒ©ãƒ³' : '2980å††ãƒ—ãƒ©ãƒ³'}ä»¥ä¸Šã§ã”è¦§ã„ãŸã ã‘ã¾ã™
                            </p>
                            <a href="plans.html" class="btn btn-primary" style="margin-top: 20px; display: inline-block;">
                                <i class="fas fa-crown"></i> ãƒ—ãƒ©ãƒ³ã‚’ç¢ºèªã™ã‚‹
                            </a>
                        </div>
                    `;
                } else {
                    // å˜ç´”ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒãªã„å ´åˆ
                    contentGrid.innerHTML = `
                        <div class="content-empty">
                            <i class="fas fa-inbox"></i>
                            <p>ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚ã‚Šã¾ã›ã‚“</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">
                                æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¿½åŠ ã•ã‚Œã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„
                            </p>
                        </div>
                    `;
                }
                return;
            }

            contentGrid.innerHTML = filteredContent.map(content => {
                const iconMap = {
                    'video': 'fas fa-video',
                    'pdf': 'fas fa-file-pdf',
                    'archive': 'fas fa-archive',
                    'quiz': 'fas fa-brain'
                };

                const icon = iconMap[content.type] || 'fas fa-file';

                const dateStr = content.publishedAt 
                    ? content.publishedAt.toLocaleDateString('ja-JP', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    })
                    : '-';

                // ãƒ—ãƒ©ãƒ³ãƒãƒƒã‚¸ã®è¡¨ç¤º
                let planBadge = '';
                if (content.requiredPlan === 'basic') {
                    planBadge = '<span style="background: rgba(0, 123, 255, 0.2); color: #66b2ff; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px;">1980å††ãƒ—ãƒ©ãƒ³</span>';
                } else if (content.requiredPlan === 'premium') {
                    planBadge = '<span style="background: rgba(255, 193, 7, 0.2); color: #ffc107; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px;">2980å††ãƒ—ãƒ©ãƒ³</span>';
                }

                // URLãŒãªã„å ´åˆã®è¡¨ç¤º
                let urlStatus = '';
                // ã‚¨ã‚³ãƒ¼å‹•ç”»ã‚«ãƒ†ã‚´ãƒªã®å ´åˆã®ç‰¹åˆ¥å‡¦ç†
                if (content.category === 'ã‚¨ã‚³ãƒ¼å‹•ç”»') {
                    if (userPlan === 'premium') {
                        // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ä¼šå“¡ã¯è¦–è´å¯èƒ½ï¼ˆecho-videos.htmlã§å…¨å‹•ç”»è¦–è´å¯èƒ½ï¼‰
                        urlStatus = '<span style="background: rgba(40, 167, 69, 0.2); color: #28a745; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px;"><i class="fas fa-crown"></i> è¦–è´å¯èƒ½</span>';
                    } else if (!content.url || content.url.trim() === '') {
                        urlStatus = '<span style="background: rgba(255, 193, 7, 0.2); color: #ffc107; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px;">æº–å‚™ä¸­</span>';
                    }
                } else if (!content.url || content.url.trim() === '') {
                    urlStatus = '<span style="background: rgba(255, 193, 7, 0.2); color: #ffc107; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px;">æº–å‚™ä¸­</span>';
                }

                return `
                    <div class="content-card" data-content-id="${content.id}" data-content-type="${content.type}" data-content-url="${content.url || ''}" data-content-title="${content.title}" data-content-category="${content.category}">
                        <div class="content-card-header">
                            <i class="${icon} content-card-icon"></i>
                            <h3 class="content-card-title">
                                ${content.title}
                                ${planBadge}
                                ${urlStatus}
                            </h3>
                        </div>
                        <p class="content-card-description">${content.description || 'èª¬æ˜ã¯ã‚ã‚Šã¾ã›ã‚“'}</p>
                        <div class="content-card-footer">
                            <span>${content.category}</span>
                            <span>${dateStr}</span>
                        </div>
                    </div>
                `;
            }).join('');

            // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelectorAll('.content-card').forEach(card => {
                card.addEventListener('click', () => {
                    const type = card.dataset.contentType;
                    const url = card.dataset.contentUrl;
                    const contentId = card.dataset.contentId;
                    const title = card.dataset.contentTitle || card.querySelector('.content-card-title').textContent.trim();
                    const contentCategory = card.dataset.contentCategory; // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è‡ªä½“ã®ã‚«ãƒ†ã‚´ãƒª
                    const currentCategoryFilter = currentCategory; // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚£ãƒ«ã‚¿

                    console.log('ğŸ” Card clicked:', {
                        title: title,
                        contentCategory: contentCategory,
                        currentCategoryFilter: currentCategoryFilter,
                        type: type,
                        url: url
                    });

                    // ã‚¨ã‚³ãƒ¼å‹•ç”»ã‚«ãƒ†ã‚´ãƒªã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å ´åˆã€echo-videos.htmlã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    if (contentCategory === 'ã‚¨ã‚³ãƒ¼å‹•ç”»') {
                        console.log('âœ… Redirecting to echo-videos.html');
                        // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ä¼šå“¡ã‚‚å«ã‚ã¦ã€echo-videos.htmlã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                        // echo-videos.htmlã§ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ä¼šå“¡ã¯è¦–è´å¯èƒ½
                        window.location.href = 'echo-videos.html';
                        return;
                    }

                    // URLãŒãªã„å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    if (!url || url.trim() === '') {
                        alert('ã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ç¾åœ¨æº–å‚™ä¸­ã§ã™ã€‚\nå…¬é–‹ã¾ã§ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
                        return;
                    }

                    if (type === 'video' || type === 'archive') {
                        openVideoModal(url);
                    } else if (type === 'pdf') {
                        window.open(url, '_blank');
                    } else if (type === 'quiz') {
                        window.open(url, '_blank');
                    }
                });
            });
        }

        // å‹•ç”»ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openVideoModal(vimeoUrl) {
            if (!vimeoUrl) return;
            
            const vimeoId = vimeoUrl.includes('vimeo.com') 
                ? vimeoUrl.split('/').pop().split('?')[0]
                : vimeoUrl;

            videoContainer.innerHTML = `
                <iframe
                    src="https://player.vimeo.com/video/${vimeoId}?badge=0&autopause=0&player_id=0&app_id=58479"
                    frameborder="0"
                    allow="autoplay; fullscreen; picture-in-picture; clipboard-write"
                    style="position:absolute;top:0;left:0;width:100%;height:100%;"
                    title="å‹•ç”»ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼">
                </iframe>
            `;

            videoModal.classList.add('active');
        }

        // å‹•ç”»ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closeVideoModal.addEventListener('click', () => {
            videoModal.classList.remove('active');
            videoContainer.innerHTML = '';
        });

        videoModal.addEventListener('click', (e) => {
            if (e.target === videoModal) {
                videoModal.classList.remove('active');
                videoContainer.innerHTML = '';
            }
        });

        // ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆ
        categoryTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                categoryTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentCategory = tab.dataset.category;
                displayContent();
            });
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        logoutBtn.addEventListener('click', async () => {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                try {
                    await signOut(auth);
                    window.location.href = 'auth.html';
                } catch (error) {
                    console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                }
            }
        });
    </script>
</body>
</html>

