# セキュリティ・法的遵守 監査レポート

## 📋 監査日
2025年1月

## ✅ 良好な点

### 1. 認証・認可
- ✅ Firebase Authenticationを使用した適切な認証実装
- ✅ ユーザーは自分のデータのみアクセス可能
- ✅ パスワードリセット機能が実装されている
- ✅ パスワード変更機能が実装されている

### 2. 決済セキュリティ
- ✅ Stripeシークレットキーはサーバー側（Firebase Functions）のみで使用
- ✅ クライアント側にStripeシークレットキーが露出していない
- ✅ Stripe Payment Linksを使用（PCI DSS準拠はStripe側で対応）
- ✅ Firebase Functionsで解約処理を実装（認証チェックあり）

### 3. データ保護
- ✅ Firestoreを使用したデータベース管理
- ✅ サーバータイムスタンプを使用した正確な日時記録
- ✅ 購入履歴の重複チェック実装

## ⚠️ 重要な問題点（即座に対応が必要）

### 🔴 1. Firestore Security Rules が未設定

**問題**: `firestore.rules`ファイルが見つかりません。現在、Firestoreのセキュリティルールが適切に設定されていない可能性があります。

**リスク**: 
- 不正アクセスによるデータ漏洩
- データの改ざん
- 他のユーザーのデータへのアクセス

**対応策**:
```javascript
// firestore.rules を作成
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ユーザー情報: 自分のデータのみ読み書き可能
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // 購入履歴: 自分の購入履歴のみ読み取り可能、書き込みは認証済みユーザーのみ
    match /purchases/{purchaseId} {
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
                       request.resource.data.userId == request.auth.uid;
      allow update, delete: if false; // 購入履歴は変更・削除不可
    }
    
    // サロンコンテンツ: 認証済みユーザーのみ読み取り可能
    match /salon_content/{contentId} {
      allow read: if request.auth != null;
      allow write: if false; // 管理ツールからは別途設定が必要
    }
  }
}
```

**実装手順**:
1. プロジェクトルートに`firestore.rules`ファイルを作成
2. 上記のルールを設定
3. Firebase Consoleでデプロイ: `firebase deploy --only firestore:rules`

---

### 🔴 2. 利用規約・プライバシーポリシーが未作成

**問題**: 利用規約とプライバシーポリシーのページが存在しません。

**法的要件**:
- **個人情報保護法**: 個人情報の取り扱いについて明示する義務
- **特定商取引法**: オンラインサービス提供者として必要
- **GDPR（EUユーザー向け）**: 個人データ処理の透明性

**必須記載事項**:

#### 利用規約に含めるべき内容:
1. サービスの内容と利用条件
2. 会員登録の条件
3. サブスクリプションの内容と料金
4. 解約方法と返金ポリシー
5. 禁止行為
6. 知的財産権
7. 免責事項
8. 準拠法と管轄裁判所

#### プライバシーポリシーに含めるべき内容:
1. 収集する個人情報の種類（メールアドレス、購入履歴など）
2. 個人情報の利用目的
3. 個人情報の第三者提供の有無
4. 個人情報の管理方法
5. Cookieの使用について
6. ユーザーの権利（アクセス、訂正、削除）
7. お問い合わせ窓口

**対応策**: `terms.html`と`privacy.html`を作成し、全ページのフッターにリンクを追加

---

### 🔴 3. 特定商取引法に基づく表記が未作成

**問題**: 特定商取引法に基づく表記ページが存在しません。

**法的要件**: オンラインで有料サービスを提供する場合、特定商取引法に基づく表記が必要です。

**必須記載事項**:
1. 事業者名・代表者名
2. 所在地・連絡先
3. 営業時間
4. 販売価格（各プランの料金）
5. 支払方法（クレジットカード）
6. 支払時期（毎月自動更新）
7. サービス提供時期（即時）
8. 返品・返金ポリシー（デジタルコンテンツのため返品不可）
9. 解約方法（Customer Portalから解約可能）

**対応策**: `law.html`を作成し、フッターにリンクを追加

---

### 🟡 4. 解約方法の明示が不十分

**現状**: `plans.html`に解約についての説明はありますが、より明確にすべきです。

**改善案**:
1. 解約方法を専用セクションで明示
2. 解約後のアクセス権限を明確に説明
3. 返金ポリシーを明記

---

### 🟡 5. Cookie・トラッキングの説明が不足

**問題**: `localStorage`を使用していますが、Cookieポリシーが明示されていません。

**対応策**:
- Cookie使用の目的を説明
- 必須Cookieと任意Cookieを区別
- Cookie設定の選択肢を提供（可能な場合）

---

### 🟡 6. Firebase APIキーの制限設定

**現状**: Firebase APIキーがクライアント側に露出しています（これは正常ですが、制限が必要です）。

**対応策**:
1. Firebase Console → プロジェクト設定 → APIキー
2. HTTPリファラー（ウェブサイト）の制限を設定
3. 許可されるドメインを指定（本番環境のドメインのみ）

---

### 🟡 7. エラーハンドリングとログ記録

**改善点**:
- エラーメッセージに機密情報が含まれていないか確認
- 適切なログ記録（個人情報を含まない）
- エラー通知の仕組み

---

## 📝 推奨される追加実装

### 1. データ保持ポリシー
- アカウント削除時のデータ保持期間を明記
- データ削除リクエストの処理方法

### 2. セキュリティ監視
- 不正ログイン検知
- 異常なアクセスパターンの監視

### 3. バックアップ・災害復旧
- Firestoreデータの定期バックアップ
- 災害復旧計画の文書化

### 4. アクセシビリティ
- WCAG 2.1 AA準拠の確認
- キーボードナビゲーションの改善

---

## 🎯 優先順位

### 最優先（即座に対応）
1. ✅ Firestore Security Rules の設定
2. ✅ 利用規約の作成
3. ✅ プライバシーポリシーの作成
4. ✅ 特定商取引法に基づく表記の作成

### 高優先度（1週間以内）
5. ✅ 解約方法の明確化
6. ✅ Cookieポリシーの追加
7. ✅ Firebase APIキーの制限設定

### 中優先度（1ヶ月以内）
8. データ保持ポリシーの明記
9. エラーハンドリングの改善
10. セキュリティ監視の実装

---

## 📚 参考資料

- [Firebase Security Rules ドキュメント](https://firebase.google.com/docs/firestore/security/get-started)
- [個人情報保護法](https://www.ppc.go.jp/)
- [特定商取引法](https://www.nochuri.co.jp/law/tokusho.html)
- [GDPR（EU一般データ保護規則）](https://gdpr.eu/)
- [Stripe セキュリティ](https://stripe.com/docs/security)

---

## ✅ チェックリスト

- [ ] Firestore Security Rules を設定・デプロイ
- [ ] 利用規約ページを作成
- [ ] プライバシーポリシーページを作成
- [ ] 特定商取引法に基づく表記ページを作成
- [ ] 全ページのフッターにリンクを追加
- [ ] 解約方法を明確化
- [ ] Cookieポリシーを追加
- [ ] Firebase APIキーの制限を設定
- [ ] データ保持ポリシーを明記
- [ ] エラーハンドリングを改善

---

**注意**: このレポートは一般的なガイドラインに基づいています。実際の法的要件は、事業の所在地、対象ユーザー、提供するサービスの内容によって異なる場合があります。必要に応じて、法律専門家に相談することをお勧めします。

