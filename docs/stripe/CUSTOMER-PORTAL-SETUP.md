# Stripe Customer Portal設定ガイド

## 概要

Stripe Customer Portalを使用することで、ユーザーが自分でプランを変更できるようになり、二重請求を防ぐことができます。

## 設定手順

### ステップ1: StripeダッシュボードでCustomer Portalを設定

1. [Stripeダッシュボード](https://dashboard.stripe.com/test)にアクセス
2. 左メニューから「設定」→「Billing」→「Customer Portal」をクリック
3. 「Customer Portalを有効化」をクリック

### ステップ2: Customer Portalの設定

以下の設定を行います：

#### 基本設定
- **顧客情報の更新**: 有効化（メールアドレス、住所などの更新を許可）
- **支払い方法の更新**: 有効化（クレジットカード情報の更新を許可）

#### サブスクリプション設定
- **プラン変更を許可**: ✅ 有効化
- **プラン変更のタイミング**: 
  - 「即座に変更」を選択（推奨）
  - または「請求期間終了時に変更」を選択
- **キャンセルを許可**: 必要に応じて設定

#### 請求履歴
- **請求履歴の表示**: 有効化（ユーザーが請求履歴を確認できるようにする）

### ステップ3: Customer Portalのリンクを取得

1. Customer Portalの設定画面で「リンクをコピー」をクリック
2. 以下のようなURLがコピーされます：
   ```
   https://billing.stripe.com/p/login/[YOUR_PORTAL_LINK]
   ```

### ステップ4: plan-payment-config.jsに設定

1. `plan-payment-config.js`を開く
2. `CUSTOMER_PORTAL_URL`の部分を更新：

```javascript
const CUSTOMER_PORTAL_URL = IS_PRODUCTION ? {
  url: 'https://billing.stripe.com/p/login/[取得した本番環境用のリンク]'
} : {
  url: 'https://billing.stripe.com/p/login/[取得したテスト環境用のリンク]'
};
```

## 動作確認

### テスト手順

1. `plans.html`にアクセス（既にプランに登録済みの状態）
2. 別のプランの「プランを変更する」ボタンをクリック
3. 確認ダイアログで「OK」をクリック
4. Stripe Customer Portalにリダイレクトされることを確認
5. Customer Portalでプランを変更できることを確認

## プラン変更の動作

### アップグレード（1980円→2980円）

- **即座に変更**の場合：
  - その日の残り日数分の差額（1000円）が即座に請求される
  - 次回請求日から2980円が請求される

- **請求期間終了時に変更**の場合：
  - 現在の請求期間は1980円のまま
  - 次回請求日から2980円が請求される

### ダウングレード（2980円→1980円）

- **即座に変更**の場合：
  - その月の残り日数分の差額が返金される（または次回請求時に調整される）
  - 次回請求日から1980円が請求される

- **請求期間終了時に変更**の場合：
  - 現在の請求期間は2980円のまま
  - 次回請求日から1980円が請求される

## 注意事項

⚠️ **重要**
- Customer Portalのリンクは、テスト環境と本番環境で異なります
- テスト環境と本番環境の両方で設定が必要です
- Customer Portalの設定は、Stripeダッシュボードでいつでも変更できます

## トラブルシューティング

### Q: Customer Portalにリダイレクトされない

**A:** 以下を確認してください：
1. `plan-payment-config.js`の`CUSTOMER_PORTAL_URL`が正しく設定されているか
2. URLに`[YOUR`が含まれていないか
3. ブラウザのコンソールでエラーがないか確認

### Q: Customer Portalでプラン変更ができない

**A:** Stripeダッシュボードで以下を確認：
1. Customer Portalの設定で「プラン変更を許可」が有効になっているか
2. プラン変更のタイミングが正しく設定されているか

### Q: 二重請求が発生する

**A:** 既存のサブスクリプションがある場合、必ずCustomer Portalから変更してください。
Payment Linkを使用すると、新しいサブスクリプションが作成されてしまいます。

