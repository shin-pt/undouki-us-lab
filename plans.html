<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ—ãƒ©ãƒ³ç™»éŒ² - é‹å‹•å™¨è¶…éŸ³æ³¢Lab</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', 'Poppins', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 15px; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
        }

        .container {
            max-width: 100%; /* ã‚¹ãƒãƒ›ã§ã¯å…¨å¹… */
            margin: 0 auto;
            padding: 0 15px; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
        }

        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-section h1 {
            font-size: 1.8rem;
            color: #e0e0e0;
            font-weight: 700;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: #e0e0e0;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            white-space: nowrap;
        }

        .nav-links a:hover {
            color: #007bff;
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-links a i {
            font-size: 1rem;
        }

        .plans-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 50px 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 40px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .current-plan-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .current-plan-section h2 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #e0e0e0;
        }

        .current-plan-badge {
            display: inline-block;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: 700;
            margin-top: 10px;
        }

        .current-plan-badge.none {
            background: rgba(255, 255, 255, 0.1);
            color: #999;
        }

        .current-plan-badge.basic {
            background: rgba(0, 123, 255, 0.2);
            color: #66b2ff;
        }

        .current-plan-badge.premium {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .plan-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 30px 25px; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’å°‘ã—å°ã•ã */
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .plan-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .plan-card.recommended {
            border-color: #ffc107;
            box-shadow: 0 0 30px rgba(255, 193, 7, 0.2);
        }

        .plan-card.recommended::before {
            content: 'ãŠã™ã™ã‚';
            position: absolute;
            top: 20px;
            right: -30px;
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: #121212;
            padding: 5px 40px;
            font-size: 0.8rem;
            font-weight: 700;
            transform: rotate(45deg);
        }

        .plan-header {
            text-align: center;
            margin-bottom: 20px; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’å°ã•ã */
        }

        .plan-name {
            font-size: 1.6rem; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’å°ã•ã */
            font-weight: 700;
            margin-bottom: 8px; /* å°ã•ã */
            color: #e0e0e0;
        }

        .plan-price {
            font-size: 2.2rem; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’å°ã•ã */
            font-weight: 900;
            margin-bottom: 4px; /* å°ã•ã */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .plan-price.recommended {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .plan-period {
            color: #999;
            font-size: 0.9rem;
        }

        .plan-features {
            list-style: none;
            margin-bottom: 20px; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’å°ã•ã */
        }

        .plan-features li {
            padding: 10px 0; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’å°ã•ã */
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            gap: 10px; /* å°ã•ã */
        }

        .plan-features li:last-child {
            border-bottom: none;
        }

        .plan-features li i {
            color: #4caf50;
            font-size: 1rem; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’å°ã•ã */
            flex-shrink: 0;
        }

        .plan-button {
            width: 100%;
            padding: 12px 24px; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’å°ã•ã */
            border: none;
            border-radius: 8px;
            font-size: 1rem; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’å°ã•ã */
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
            display: block;
            text-align: center;
        }

        .plan-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .plan-button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .plan-button.recommended {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: #121212;
        }

        .plan-button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        .plan-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .comparison-table {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px 15px; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
            margin-top: 30px;
            overflow-x: auto;
        }

        /* --- Plan Management Section --- */
        .plan-management-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 30px;
            margin-top: 40px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .comparison-table h2 {
            font-size: 1.4rem; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
            margin-bottom: 20px;
            text-align: center;
            color: #e0e0e0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 280px; /* æœ€å°å¹…ã‚’è¨­å®š */
        }

        th, td {
            padding: 10px 8px; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
            text-align: center; /* ä¸­å¤®æƒãˆ */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
            vertical-align: middle;
        }

        th {
            font-weight: 700;
            color: #e0e0e0;
            white-space: nowrap; /* ãƒ˜ãƒƒãƒ€ãƒ¼ãŒæŠ˜ã‚Šè¿”ã•ã‚Œãªã„ã‚ˆã†ã« */
        }

        th:first-child {
            text-align: left; /* æ©Ÿèƒ½åˆ—ã¯å·¦æƒãˆ */
            padding-left: 12px;
        }

        td {
            color: #ccc;
        }

        td:first-child {
            text-align: left; /* æ©Ÿèƒ½åˆ—ã¯å·¦æƒãˆ */
            padding-left: 12px;
            font-weight: 500;
        }

        .check-icon {
            color: #4caf50;
            font-size: 1rem; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
            color: #81c784;
            display: block;
        }

        .message.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            color: #e57373;
            display: block;
        }

        /* --- Responsive Design (Mobile-First) --- */

        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œ (768pxä»¥ä¸Š) */
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }

            .container {
                max-width: 1140px;
                padding: 0 20px;
            }

            .header {
                padding: 30px;
                margin-bottom: 30px;
            }

            .header-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }

            .nav-links {
                flex-direction: row;
                gap: 15px;
                width: auto;
            }

            .nav-links a {
                width: auto;
                padding: 8px 12px;
                font-size: 0.95rem;
            }

            .plans-container {
                padding: 50px 40px;
            }

            .page-title {
                font-size: 2.5rem;
            }

            .plans-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }

            .plan-card {
                padding: 35px 28px; /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆä»¥ä¸Šã§ã¯å°‘ã—å¤§ãã */
            }

            .plan-header {
                margin-bottom: 25px;
            }

            .plan-name {
                font-size: 1.7rem;
            }

            .plan-price {
                font-size: 2.4rem;
            }

            .plan-features {
                margin-bottom: 25px;
            }

            .plan-features li {
                padding: 11px 0;
            }

            .plan-button {
                padding: 14px 28px;
                font-size: 1.05rem;
            }

            .comparison-table {
                padding: 30px;
                margin-top: 40px;
            }

            .comparison-table h2 {
                font-size: 1.8rem;
                margin-bottom: 30px;
            }

            th, td {
                padding: 15px;
                font-size: 0.95rem;
            }

            .check-icon {
                font-size: 1.2rem;
            }
        }

        /* ã‚¹ãƒãƒ›å¯¾å¿œ (768pxæœªæº€) */
        @media (max-width: 767px) {
            .plans-grid {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 20px 15px;
                margin-bottom: 20px;
            }

            .plans-container {
                padding: 25px 15px; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
            }

            .page-title {
                font-size: 1.8rem;
                margin-bottom: 25px;
            }

            .plan-card {
                padding: 20px 15px; /* ã‚¹ãƒãƒ›å‘ã‘ã«ã•ã‚‰ã«å°ã•ã */
            }

            .plan-header {
                margin-bottom: 15px; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
            }

            .plan-name {
                font-size: 1.4rem; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
                margin-bottom: 6px;
            }

            .plan-price {
                font-size: 1.9rem; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
                margin-bottom: 2px;
            }

            .plan-period {
                font-size: 0.85rem; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
            }

            .plan-features {
                margin-bottom: 15px; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
            }

            .plan-features li {
                padding: 8px 0; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
                gap: 8px;
            }

            .plan-features li i {
                font-size: 0.9rem; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
            }

            .plan-button {
                padding: 12px 18px; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
                min-height: 48px;
                font-size: 0.9rem; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
            }

            .plan-card.recommended::before {
                top: 15px; /* ã‚¹ãƒãƒ›å‘ã‘ã«èª¿æ•´ */
                right: -25px;
                padding: 4px 35px;
                font-size: 0.7rem;
            }

            .comparison-table {
                padding: 15px 10px; /* ã•ã‚‰ã«å°ã•ã */
                margin-top: 25px;
            }

            .comparison-table h2 {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }

            .plan-management-section {
                padding: 20px 15px;
                margin-top: 30px;
            }

            th, td {
                padding: 8px 6px; /* ã•ã‚‰ã«å°ã•ã */
                font-size: 0.8rem;
            }

            th:first-child,
            td:first-child {
                padding-left: 8px;
            }

            .check-icon {
                font-size: 0.9rem;
            }

            .current-plan-section {
                padding: 20px 15px;
                margin-bottom: 25px;
            }

            .current-plan-section h2 {
                font-size: 1.2rem;
            }

            .current-plan-badge {
                padding: 10px 20px;
                font-size: 1rem;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .logo-section h1 {
                font-size: 1.4rem;
            }

            .nav-links {
                width: 100%;
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }

            .nav-links a {
                width: 100%;
                padding: 12px 15px;
                font-size: 0.9rem;
                justify-content: flex-start;
                border: 1px solid rgba(255, 255, 255, 0.1);
                background: rgba(255, 255, 255, 0.03);
            }

            .nav-links a:hover {
                background: rgba(255, 255, 255, 0.08);
            }

            .nav-links a i {
                font-size: 1.1rem;
                width: 20px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="logo-section">
                    <h1>é‹å‹•å™¨è¶…éŸ³æ³¢Lab</h1>
                </div>
                <nav class="nav-links">
                    <a href="index.html"><i class="fas fa-home"></i> ãƒ›ãƒ¼ãƒ </a>
                    <a href="member.html"><i class="fas fa-user"></i> ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
                    <a href="salon.html"><i class="fas fa-users"></i> ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚µãƒ­ãƒ³</a>
                    <a href="echo-videos.html"><i class="fas fa-video"></i> ã‚¨ã‚³ãƒ¼å‹•ç”»</a>
                    <a href="/quiz-app/"><i class="fas fa-question-circle"></i> ã‚¨ã‚³ãƒ¼ã‚¯ã‚¤ã‚º</a>
                    <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
                </nav>
            </div>
        </div>

        <!-- Plans Content -->
        <div class="plans-container">
            <h1 class="page-title"><i class="fas fa-crown"></i> ãƒ—ãƒ©ãƒ³ç™»éŒ²</h1>

            <div id="loadingSection" class="loading">
                <div class="spinner"></div>
                <p>èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>

            <div id="contentSection" style="display: none;">
                <!-- ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³è¡¨ç¤º -->
                <div class="current-plan-section">
                    <h2><i class="fas fa-user-circle"></i> ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³</h2>
                    <div id="currentPlanBadge" class="current-plan-badge none">æœªç™»éŒ²</div>
                    <p id="currentPlanDescription" style="margin-top: 15px; color: #999;">
                        ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²ã™ã‚‹ã¨ã€ã‚ˆã‚Šå¤šãã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™
                    </p>
                </div>

                <div id="message" class="message"></div>

                <!-- ãƒ—ãƒ©ãƒ³ã‚«ãƒ¼ãƒ‰ -->
                <div class="plans-grid">
                    <!-- 1980å††ãƒ—ãƒ©ãƒ³ -->
                    <div class="plan-card">
                        <div class="plan-header">
                            <div class="plan-name">1980å††ãƒ—ãƒ©ãƒ³</div>
                            <div class="plan-price">Â¥1,980</div>
                            <div class="plan-period">/æœˆ</div>
                        </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle"></i> ã‚¨ã‚³ãƒ¼ã‚¢ãƒ—ãƒªä½¿ç”¨</li>
                            <li><i class="fas fa-check-circle"></i> Noteè¨˜äº‹é–²è¦§</li>
                            <li><i class="fas fa-check-circle"></i> ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‹•ç”»</li>
                        </ul>
                        <button class="plan-button primary" id="basicPlanBtn" data-plan="basic">
                            <i class="fas fa-crown"></i> ã“ã®ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²
                        </button>
                    </div>

                    <!-- 2980å††ãƒ—ãƒ©ãƒ³ -->
                    <div class="plan-card recommended">
                        <div class="plan-header">
                            <div class="plan-name">2980å††ãƒ—ãƒ©ãƒ³</div>
                            <div class="plan-price recommended">Â¥2,980</div>
                            <div class="plan-period">/æœˆ</div>
                        </div>
                        <ul class="plan-features">
                            <li><i class="fas fa-check-circle"></i> 1980å††ãƒ—ãƒ©ãƒ³ã®ã™ã¹ã¦</li>
                            <li><i class="fas fa-check-circle"></i> PDFè³‡æ–™</li>
                            <li><i class="fas fa-check-circle"></i> ã‚¨ã‚³ãƒ¼å‹•ç”»</li>
                        </ul>
                        <button class="plan-button recommended" id="premiumPlanBtn" data-plan="premium">
                            <i class="fas fa-crown"></i> ã“ã®ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²
                        </button>
                    </div>
                </div>

                <!-- æ¯”è¼ƒè¡¨ -->
                <div class="comparison-table">
                    <h2><i class="fas fa-table"></i> ãƒ—ãƒ©ãƒ³æ¯”è¼ƒ</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>æ©Ÿèƒ½</th>
                                <th>1980å††ãƒ—ãƒ©ãƒ³</th>
                                <th>2980å††ãƒ—ãƒ©ãƒ³</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ã‚¨ã‚³ãƒ¼ã‚¢ãƒ—ãƒªä½¿ç”¨</td>
                                <td><i class="fas fa-check-circle check-icon"></i></td>
                                <td><i class="fas fa-check-circle check-icon"></i></td>
                            </tr>
                            <tr>
                                <td>Noteè¨˜äº‹é–²è¦§</td>
                                <td><i class="fas fa-check-circle check-icon"></i></td>
                                <td><i class="fas fa-check-circle check-icon"></i></td>
                            </tr>
                            <tr>
                                <td>ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‹•ç”»</td>
                                <td><i class="fas fa-check-circle check-icon"></i></td>
                                <td><i class="fas fa-check-circle check-icon"></i></td>
                            </tr>
                            <tr>
                                <td>PDFè³‡æ–™</td>
                                <td>-</td>
                                <td><i class="fas fa-check-circle check-icon"></i></td>
                            </tr>
                            <tr>
                                <td>ã‚¨ã‚³ãƒ¼å‹•ç”»</td>
                                <td>-</td>
                                <td><i class="fas fa-check-circle check-icon"></i></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ãƒ—ãƒ©ãƒ³ã®å¤‰æ›´ãƒ»è§£ç´„ã«ã¤ã„ã¦ -->
                <div id="planManagementInfo" class="plan-management-section" style="display: none;">
                    <p style="color: #ccc; font-size: 0.9rem; line-height: 1.7; margin-bottom: 15px;">
                        <i class="fas fa-info-circle" style="color: #667eea;"></i>
                        <strong>ãƒ—ãƒ©ãƒ³ã®å¤‰æ›´ãƒ»è§£ç´„ã«ã¤ã„ã¦</strong>
                    </p>
                    <p style="color: #999; font-size: 0.85rem; line-height: 1.7; margin-bottom: 15px;">
                        ãƒ—ãƒ©ãƒ³ã®å¤‰æ›´ã‚„è§£ç´„ã¯ã€Stripe Customer Portalã‹ã‚‰è¡Œãˆã¾ã™ã€‚<br>
                        ãƒ—ãƒ©ãƒ³å¤‰æ›´æ™‚ã¯äºŒé‡è«‹æ±‚ã‚’é˜²ããŸã‚ã€å¿…ãšCustomer Portalã‹ã‚‰å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
                    </p>
                    <div style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #ffc107; padding: 15px; margin-top: 15px; border-radius: 4px;">
                        <p style="color: #ffc107; font-size: 0.9rem; font-weight: 700; margin-bottom: 10px;">
                            <i class="fas fa-exclamation-triangle"></i> è§£ç´„ã«ã¤ã„ã¦
                        </p>
                        <p style="color: #ccc; font-size: 0.85rem; line-height: 1.7; margin-bottom: 10px;">
                            <strong>è§£ç´„æ–¹æ³•:</strong><br>
                            1. ä¸‹ã®ã€ŒCustomer Portalã‚’é–‹ãã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯<br>
                            2. Customer Portalã§ã€Œã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã‚’é¸æŠ<br>
                            3. ç¢ºèªç”»é¢ã§è§£ç´„ã‚’å®Œäº†
                        </p>
                        <p style="color: #ccc; font-size: 0.85rem; line-height: 1.7; margin-bottom: 10px;">
                            <strong>è§£ç´„å¾Œã®ã‚¢ã‚¯ã‚»ã‚¹:</strong><br>
                            è§£ç´„å¾Œã‚‚ã€ç¾åœ¨ã®è«‹æ±‚æœŸé–“çµ‚äº†ã¾ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚<br>
                            ä¾‹: 1æœˆ15æ—¥ã«è§£ç´„ã—ãŸå ´åˆã€1æœˆæœ«ã¾ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚
                        </p>
                        <p style="color: #ccc; font-size: 0.85rem; line-height: 1.7;">
                            <strong>æ³¨æ„:</strong><br>
                            è§£ç´„å¾Œã¯è‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã¾ã›ã‚“ã€‚å†ç™»éŒ²ã™ã‚‹å ´åˆã¯ã€å†åº¦ãƒ—ãƒ©ãƒ³ç™»éŒ²ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
                        </p>
                    </div>
                    <button 
                        class="plan-button secondary" 
                        id="openCustomerPortalBtn" 
                        style="margin-top: 15px; display: none;">
                        <i class="fas fa-external-link-alt"></i> Customer Portalã‚’é–‹ãï¼ˆãƒ—ãƒ©ãƒ³å¤‰æ›´ãƒ»è§£ç´„ï¼‰
                    </button>
                    <button 
                        class="plan-button" 
                        id="cancelSubscriptionBtn" 
                        style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; margin-top: 15px; display: none;"
                        data-plan="cancel">
                        <i class="fas fa-times-circle"></i> ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’è§£ç´„ã™ã‚‹
                    </button>
                    <div id="cancelLoading" style="display: none; text-align: center; margin-top: 10px;">
                        <div class="spinner"></div>
                        <p style="color: #999; font-size: 0.85rem;">è§£ç´„å‡¦ç†ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stripe Payment Linksè¨­å®š -->
    <script src="plan-payment-config.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            doc,
            getDoc,
            updateDoc,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { 
            getFunctions, 
            httpsCallable 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyAGKikNortFcMI_uLnGn2y_OyI6ZyxLiR0",
            authDomain: "musculoskeletal-us-lab.firebaseapp.com",
            projectId: "musculoskeletal-us-lab",
            storageBucket: "musculoskeletal-us-lab.firebasestorage.app",
            messagingSenderId: "199172067938",
            appId: "1:199172067938:web:cdbcf04400cc74a784b73b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);
        const cancelSubscription = httpsCallable(functions, 'cancelSubscription');

        // ç’°å¢ƒåˆ¤å®šï¼ˆæœ¬ç•ªç’°å¢ƒã‹ã©ã†ã‹ï¼‰
        // file://ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚„localhostã€127.0.0.1ã®å ´åˆã¯ãƒ†ã‚¹ãƒˆç’°å¢ƒ
        const hostname = window.location.hostname || '';
        const protocol = window.location.protocol || '';
        const IS_PRODUCTION = hostname !== 'localhost' &&
                              hostname !== '127.0.0.1' &&
                              hostname !== '' &&
                              protocol !== 'file:';

        // Stripe Payment Linksè¨­å®šï¼ˆç’°å¢ƒã«å¿œã˜ã¦åˆ‡ã‚Šæ›¿ãˆï¼‰
        const PLAN_PAYMENT_LINKS = IS_PRODUCTION ? {
            // æœ¬ç•ªç’°å¢ƒç”¨ Payment Links
            'basic': 'https://buy.stripe.com/14A14ncel0sQ6dA7bMeME1y', // 1980å††ãƒ—ãƒ©ãƒ³
            'premium': 'https://buy.stripe.com/fZu4gz929b7ufOa7bMeME1z' // 2980å††ãƒ—ãƒ©ãƒ³
        } : {
            // ãƒ†ã‚¹ãƒˆç’°å¢ƒç”¨ Payment Links
            'basic': 'https://buy.stripe.com/test_bJe9ATfqx6Re59w3ZAeME02', // 1980å††ãƒ—ãƒ©ãƒ³ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
            'premium': 'https://buy.stripe.com/test_00w8wP4LT1wUcBYeEeeME03' // 2980å††ãƒ—ãƒ©ãƒ³ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
        };

        // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šç’°å¢ƒæƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
        console.log('ğŸ” Environment Detection:', {
            hostname: hostname,
            protocol: protocol,
            isProduction: IS_PRODUCTION,
            paymentLinks: PLAN_PAYMENT_LINKS
        });

        // UIè¦ç´ 
        const loadingSection = document.getElementById('loadingSection');
        const contentSection = document.getElementById('contentSection');
        const logoutBtn = document.getElementById('logoutBtn');
        const currentPlanBadge = document.getElementById('currentPlanBadge');
        const currentPlanDescription = document.getElementById('currentPlanDescription');
        const planManagementInfo = document.getElementById('planManagementInfo');
        const basicPlanBtn = document.getElementById('basicPlanBtn');
        const premiumPlanBtn = document.getElementById('premiumPlanBtn');
        const message = document.getElementById('message');

        let currentUserPlan = null;

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        function showMessage(text, type) {
            message.className = `message ${type}`;
            message.textContent = text;
            message.style.display = 'block';
            setTimeout(() => {
                message.style.display = 'none';
            }, 5000);
        }

        // ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
        async function displayCurrentPlan(plan) {
            currentUserPlan = plan;
            const cancelSubscriptionBtn = document.getElementById('cancelSubscriptionBtn');
            
            if (!plan) {
                currentPlanBadge.className = 'current-plan-badge none';
                currentPlanBadge.textContent = 'æœªç™»éŒ²';
                currentPlanDescription.textContent = 'ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²ã™ã‚‹ã¨ã€ã‚ˆã‚Šå¤šãã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™';
                planManagementInfo.style.display = 'none';
                if (cancelSubscriptionBtn) cancelSubscriptionBtn.style.display = 'none';
                basicPlanBtn.textContent = 'ã“ã®ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²';
                premiumPlanBtn.textContent = 'ã“ã®ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²';
                basicPlanBtn.disabled = false;
                premiumPlanBtn.disabled = false;
            } else {
                if (plan === 'basic') {
                    currentPlanBadge.className = 'current-plan-badge basic';
                    currentPlanBadge.textContent = '1980å††ãƒ—ãƒ©ãƒ³';
                    currentPlanDescription.textContent = 'ã‚¨ã‚³ãƒ¼ã‚¢ãƒ—ãƒªã€Noteè¨˜äº‹ã€ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‹•ç”»ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½';
                    basicPlanBtn.textContent = 'ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³';
                    premiumPlanBtn.textContent = 'ãƒ—ãƒ©ãƒ³ã‚’å¤‰æ›´ã™ã‚‹';
                    basicPlanBtn.disabled = true;
                    premiumPlanBtn.disabled = false;
                } else if (plan === 'premium') {
                    currentPlanBadge.className = 'current-plan-badge premium';
                    currentPlanBadge.textContent = '2980å††ãƒ—ãƒ©ãƒ³';
                    currentPlanDescription.textContent = 'ã™ã¹ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½';
                    basicPlanBtn.textContent = 'ãƒ—ãƒ©ãƒ³ã‚’å¤‰æ›´ã™ã‚‹';
                    premiumPlanBtn.textContent = 'ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³';
                    basicPlanBtn.disabled = false;
                    premiumPlanBtn.disabled = true;
                }
                
                planManagementInfo.style.display = 'block';
                
                // Customer Portalãƒœã‚¿ãƒ³ã¨è§£ç´„ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                // ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€Customer Portalãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                // stripeSubscriptionIdãŒã‚ã‚‹å ´åˆã¯ã€ç›´æ¥è§£ç´„ãƒœã‚¿ãƒ³ã‚‚è¡¨ç¤º
                try {
                    const user = auth.currentUser;
                    const openCustomerPortalBtn = document.getElementById('openCustomerPortalBtn');
                    
                    if (user) {
                        const userDoc = await getDoc(doc(db, 'users', user.uid));
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            
                            // ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€Customer Portalãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                            // ï¼ˆstripeSubscriptionIdãŒãªãã¦ã‚‚ã€Customer Portalã§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½ï¼‰
                            if (openCustomerPortalBtn) {
                                openCustomerPortalBtn.style.display = 'block';
                            }
                            
                            // stripeSubscriptionIdãŒã‚ã‚‹å ´åˆã®ã¿ã€ç›´æ¥è§£ç´„ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                            if (userData.stripeSubscriptionId && cancelSubscriptionBtn) {
                                cancelSubscriptionBtn.style.display = 'block';
                            } else if (cancelSubscriptionBtn) {
                                cancelSubscriptionBtn.style.display = 'none';
                            }
                        }
                    }
                } catch (error) {
                    console.error('ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                    const openCustomerPortalBtn = document.getElementById('openCustomerPortalBtn');
                    if (cancelSubscriptionBtn) cancelSubscriptionBtn.style.display = 'none';
                    if (openCustomerPortalBtn) openCustomerPortalBtn.style.display = 'none';
                }
            }
        }

        // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³è§£ç´„é–¢æ•°
        async function handleCancelSubscription() {
            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            const confirmed = confirm(
                'æœ¬å½“ã«ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’è§£ç´„ã—ã¾ã™ã‹ï¼Ÿ\n\n' +
                'è§£ç´„å¾Œã‚‚ç¾åœ¨ã®è«‹æ±‚æœŸé–“çµ‚äº†ã¾ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚\n\n' +
                'ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚'
            );
            
            if (!confirmed) {
                return;
            }

            const cancelLoading = document.getElementById('cancelLoading');
            const cancelSubscriptionBtn = document.getElementById('cancelSubscriptionBtn');

            try {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                if (cancelLoading) cancelLoading.style.display = 'block';
                if (cancelSubscriptionBtn) cancelSubscriptionBtn.disabled = true;

                // è§£ç´„å®Ÿè¡Œï¼ˆè«‹æ±‚æœŸé–“çµ‚äº†æ™‚ã«è§£ç´„ï¼‰
                const result = await cancelSubscription({ cancelAtPeriodEnd: true });
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                alert(
                    'ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®è§£ç´„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\n' +
                    'ç¾åœ¨ã®è«‹æ±‚æœŸé–“çµ‚äº†ã¾ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚\n\n' +
                    'ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
                );
                
                // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦çŠ¶æ…‹ã‚’æ›´æ–°
                window.location.reload();
            } catch (error) {
                console.error('è§£ç´„ã‚¨ãƒ©ãƒ¼:', error);
                
                let errorMessage = 'è§£ç´„ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                if (error.code === 'unauthenticated') {
                    errorMessage = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
                } else if (error.code === 'failed-precondition') {
                    errorMessage = 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                alert(errorMessage);
            } finally {
                if (cancelLoading) cancelLoading.style.display = 'none';
                if (cancelSubscriptionBtn) cancelSubscriptionBtn.disabled = false;
            }
        }

        // Customer Portalã‚’é–‹ãé–¢æ•°
        async function handleOpenCustomerPortal() {
            // plan-payment-config.jsã‹ã‚‰Customer Portal URLã‚’å–å¾—
            let customerPortalUrl = null;
            
            if (typeof CUSTOMER_PORTAL_URL !== 'undefined' && CUSTOMER_PORTAL_URL) {
                customerPortalUrl = CUSTOMER_PORTAL_URL.url;
            }
            
            if (!customerPortalUrl || customerPortalUrl.includes('[YOUR')) {
                showMessage('Customer Portalã®è¨­å®šãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚\n\nç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚', 'error');
                console.warn('âš ï¸ Customer Portal URL not configured');
                return;
            }
            
            // Customer Portalã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            window.location.href = customerPortalUrl;
        }

        // è§£ç´„ãƒœã‚¿ãƒ³ã¨Customer Portalãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        window.addEventListener('DOMContentLoaded', () => {
            const cancelSubscriptionBtn = document.getElementById('cancelSubscriptionBtn');
            const openCustomerPortalBtn = document.getElementById('openCustomerPortalBtn');
            
            if (cancelSubscriptionBtn) {
                cancelSubscriptionBtn.addEventListener('click', handleCancelSubscription);
            }
            
            if (openCustomerPortalBtn) {
                openCustomerPortalBtn.addEventListener('click', handleOpenCustomerPortal);
            }
        });

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’å–å¾—
        async function getUserPlan(user) {
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    return userData.plan || null;
                }
                return null;
            } catch (error) {
                console.error('ãƒ—ãƒ©ãƒ³æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
        async function getUserSubscription(user) {
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    return {
                        hasSubscription: !!userData.stripeSubscriptionId,
                        customerId: userData.stripeCustomerId || null,
                        subscriptionId: userData.stripeSubscriptionId || null,
                        plan: userData.plan || null
                    };
                }
                return null;
            } catch (error) {
                console.error('ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }

        // ãƒ—ãƒ©ãƒ³ã‚’æ›´æ–°ï¼ˆç›´æ¥æ›´æ–°ç”¨ã€ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰
        async function updatePlanDirect(plan) {
            const user = auth.currentUser;
            if (!user) {
                showMessage('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚', 'error');
                return;
            }

            try {
                const userRef = doc(db, 'users', user.uid);
                await updateDoc(userRef, {
                    plan: plan,
                    planStartDate: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });

                await displayCurrentPlan(plan);
                showMessage(`ãƒ—ãƒ©ãƒ³ãŒ${plan === 'basic' ? '1980å††ãƒ—ãƒ©ãƒ³' : '2980å††ãƒ—ãƒ©ãƒ³'}ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚`, 'success');
                
                // 3ç§’å¾Œã«salon.htmlã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                setTimeout(() => {
                    window.location.href = 'salon.html';
                }, 3000);
            } catch (error) {
                console.error('ãƒ—ãƒ©ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('ãƒ—ãƒ©ãƒ³ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
            }
        }

        // Stripe Customer Portalã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆæ—¢å­˜ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆï¼‰
        async function redirectToCustomerPortal() {
            const user = auth.currentUser;
            if (!user) {
                showMessage('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚', 'error');
                return;
            }

            // Customer Portalã®URLï¼ˆplan-payment-config.jsã‹ã‚‰å–å¾—ï¼‰
            let customerPortalUrl = null;
            
            // plan-payment-config.jsã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
            if (typeof CUSTOMER_PORTAL_URL !== 'undefined' && CUSTOMER_PORTAL_URL) {
                customerPortalUrl = CUSTOMER_PORTAL_URL.url;
            }
            
            // å–å¾—ã§ããªã„å ´åˆã¯ç›´æ¥è¨­å®šï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            if (!customerPortalUrl || customerPortalUrl.includes('[YOUR')) {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥è¨­å®šï¼ˆplan-payment-config.jsã«è¨­å®šã—ã¦ãã ã•ã„ï¼‰
                customerPortalUrl = IS_PRODUCTION
                    ? 'https://billing.stripe.com/p/login/[YOUR_LIVE_PORTAL_LINK]'
                    : 'https://billing.stripe.com/p/login/test_dRmeVd2DL2AYdG27bMeME00';
            }

            if (!customerPortalUrl || customerPortalUrl.includes('[YOUR')) {
                showMessage('Customer Portalã®è¨­å®šãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚\n\nç¾åœ¨ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã¯ã€Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ç›´æ¥æ“ä½œã—ã¦ãã ã•ã„ã€‚\n\nè¨­å®šæ–¹æ³•ã¯ docs/stripe/CUSTOMER-PORTAL-SETUP.md ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚', 'error');
                console.warn('âš ï¸ Customer Portal URL not configured');
                console.warn('ğŸ’¡ plan-payment-config.jsã®CUSTOMER_PORTAL_URLã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                return;
            }

            // Customer Portalã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            console.log('ğŸ¯ Redirecting to Customer Portal:', customerPortalUrl);
            window.location.href = customerPortalUrl;
        }

        // Stripe Payment Linkã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆæ–°è¦ç™»éŒ²æ™‚ï¼‰
        async function redirectToStripe(plan) {
            const user = auth.currentUser;
            if (!user) {
                showMessage('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚', 'error');
                return;
            }

            // æ—¢å­˜ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const subscription = await getUserSubscription(user);
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
            console.log('ğŸ” Subscription check:', {
                subscription: subscription,
                hasPlan: subscription?.plan,
                hasSubscription: subscription?.hasSubscription,
                customerId: subscription?.customerId
            });
            
            // æ—¢å­˜ã®ãƒ—ãƒ©ãƒ³ãŒã‚ã‚‹å ´åˆï¼ˆplanãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
            // æ³¨æ„: ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ç™»éŒ²ã—ãŸå ´åˆã€stripeSubscriptionIdã¯ãªã„ãŒã€planãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯è¨­å®šã•ã‚Œã¦ã„ã‚‹
            if (subscription && subscription.plan) {
                console.log('âœ… Existing plan found:', subscription.plan);
                const currentPlanName = subscription.plan === 'basic' ? '1980å††ãƒ—ãƒ©ãƒ³' : 
                                       subscription.plan === 'premium' ? '2980å††ãƒ—ãƒ©ãƒ³' : 'ãƒ—ãƒ©ãƒ³';
                const targetPlanName = plan === 'basic' ? '1980å††ãƒ—ãƒ©ãƒ³' : '2980å††ãƒ—ãƒ©ãƒ³';
                
                // stripeSubscriptionIdãŒãªã„å ´åˆï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ç™»éŒ²ã—ãŸå ´åˆï¼‰
                if (!subscription.hasSubscription) {
                    console.warn('âš ï¸ stripeSubscriptionIdãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ç™»éŒ²ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                    console.warn('ğŸ’¡ å®Ÿéš›ã®Stripeæ±ºæ¸ˆã§ç™»éŒ²ã™ã‚‹å ´åˆã¯ã€Stripe Payment Linkã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚');
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é¸æŠè‚¢ã‚’æä¾›
                    const userChoice = confirm(
                        `ç¾åœ¨${currentPlanName}ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰ã€‚\n\n` +
                        `å®Ÿéš›ã®Stripeæ±ºæ¸ˆã§${targetPlanName}ã«ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\n\n` +
                        `ã€ŒOKã€: Stripeæ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«ç§»å‹•\n` +
                        `ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€: ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ã¾ã¾ãƒ—ãƒ©ãƒ³ã‚’å¤‰æ›´`
                    );
                    
                    if (userChoice) {
                        // Stripeæ±ºæ¸ˆã§ç™»éŒ²ã™ã‚‹å ´åˆã€æ—¢å­˜ã®ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                        console.log('ğŸ”„ Clearing test mode plan before Stripe registration...');
                        try {
                            await updateDoc(doc(db, 'users', user.uid), {
                                plan: null,
                                planStartDate: null,
                                planEndDate: null,
                                updatedAt: serverTimestamp()
                            });
                            console.log('âœ… Test mode plan cleared');
                        } catch (error) {
                            console.warn('âš ï¸ Failed to clear test mode plan:', error);
                            // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ç¶šè¡Œï¼ˆStripeæ±ºæ¸ˆå¾Œã«ä¸Šæ›¸ãã•ã‚Œã‚‹ãŸã‚ï¼‰
                        }
                        // ã“ã®å¾Œã€Stripe Payment Linkã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ç¶šãï¼‰
                    } else {
                        // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ã¾ã¾ãƒ—ãƒ©ãƒ³ã‚’å¤‰æ›´
                        await updatePlanDirect(plan);
                        return;
                    }
                } else {
                    // å®Ÿéš›ã®Stripeã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã€Customer Portalã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    if (confirm(`ç¾åœ¨${currentPlanName}ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚\n\nãƒ—ãƒ©ãƒ³ã‚’${targetPlanName}ã«å¤‰æ›´ã™ã‚‹ã«ã¯ã€Stripe Customer Portalã‹ã‚‰å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚\n\nCustomer Portalã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        await redirectToCustomerPortal();
                    }
                    return;
                }
            }

            // æ–°è¦ç™»éŒ²ã®å ´åˆã®ã¿Payment Linkã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            const paymentLink = PLAN_PAYMENT_LINKS[plan];

            if (!paymentLink) {
                console.error(`Payment Link not found for plan: ${plan}`);
                showMessage('ã“ã®ãƒ—ãƒ©ãƒ³ã®ç™»éŒ²ãƒªãƒ³ã‚¯ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚', 'error');
                return;
            }

            // ãƒ—ãƒ©ãƒ³ç™»éŒ²å‰ã«æƒ…å ±ã‚’LocalStorageã«ä¿å­˜ï¼ˆæˆåŠŸæ™‚ã®å‡¦ç†ç”¨ï¼‰
            try {
                localStorage.setItem('pending_plan_registration', plan);
                localStorage.setItem('pending_plan_user_id', user.uid);
                localStorage.setItem('pending_plan_user_email', user.email);
                localStorage.setItem('plan_registration_timestamp', Date.now().toString());
                console.log(`ğŸ“ Pending plan registration saved: ${plan} for user ${user.uid}`);
            } catch (e) {
                console.warn('âš ï¸ Failed to save pending plan registration:', e);
            }

            // Stripe Payment Linkã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            console.log(`ğŸ¯ Redirecting to payment page for plan: ${plan}`);
            console.log(`ğŸ”— Payment Link URL: ${paymentLink}`);
            console.log(`ğŸŒ Environment: ${IS_PRODUCTION ? 'PRODUCTION' : 'TEST'}`);
            window.location.href = paymentLink;
        }

        // ãƒ—ãƒ©ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        basicPlanBtn.addEventListener('click', () => {
            if (currentUserPlan === 'basic') return;
            
            // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’ç¢ºèªï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§åˆ¶å¾¡å¯èƒ½ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const testMode = urlParams.get('test') === 'true';
            
            if (testMode) {
                // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šç›´æ¥ãƒ—ãƒ©ãƒ³ã‚’æ›´æ–°
                if (confirm('1980å††ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šå®Ÿéš›ã®æ±ºæ¸ˆã¯è¡Œã‚ã‚Œã¾ã›ã‚“')) {
                    updatePlanDirect('basic');
                }
            } else {
                // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ï¼šStripe Payment Linkã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                if (confirm('1980å††ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\n\nStripeæ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚')) {
                    redirectToStripe('basic');
                }
            }
        });

        premiumPlanBtn.addEventListener('click', () => {
            if (currentUserPlan === 'premium') return;
            
            // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’ç¢ºèª
            const urlParams = new URLSearchParams(window.location.search);
            const testMode = urlParams.get('test') === 'true';
            
            if (testMode) {
                // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šç›´æ¥ãƒ—ãƒ©ãƒ³ã‚’æ›´æ–°
                if (confirm('2980å††ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šå®Ÿéš›ã®æ±ºæ¸ˆã¯è¡Œã‚ã‚Œã¾ã›ã‚“')) {
                    updatePlanDirect('premium');
                }
            } else {
                // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ï¼šStripe Payment Linkã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                if (confirm('2980å††ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\n\nStripeæ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚')) {
                    redirectToStripe('premium');
                }
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        logoutBtn.addEventListener('click', async () => {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                try {
                    await signOut(auth);
                    window.location.href = 'auth.html';
                } catch (error) {
                    console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            }
        });

        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å ´åˆ
                try {
                    const plan = await getUserPlan(user);
                    await displayCurrentPlan(plan);
                    loadingSection.style.display = 'none';
                    contentSection.style.display = 'block';
                } catch (error) {
                    console.error('ãƒ—ãƒ©ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    loadingSection.innerHTML = `
                        <div class="spinner"></div>
                        <p>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p>
                        <p style="font-size: 0.9rem; margin-top: 10px; color: #999;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                    `;
                }
            } else {
                // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                window.location.href = 'auth.html';
            }
        });
    </script>

    <!-- Footer -->
    <footer style="padding: 30px 0; background-color: #0c0c0c; text-align: center; margin-top: 50px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">
            <p style="color: #999; font-size: 0.85rem; margin-bottom: 10px;">
                <a href="terms.html" style="color: #999; text-decoration: none; margin: 0 10px; transition: color 0.3s ease;">åˆ©ç”¨è¦ç´„</a>
                <span style="color: #666;">|</span>
                <a href="privacy.html" style="color: #999; text-decoration: none; margin: 0 10px; transition: color 0.3s ease;">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
                <span style="color: #666;">|</span>
                <a href="law.html" style="color: #999; text-decoration: none; margin: 0 10px; transition: color 0.3s ease;">ç‰¹å®šå•†å–å¼•æ³•ã«åŸºã¥ãè¡¨è¨˜</a>
            </p>
            <p style="color: #555; font-size: 0.9rem;">Â© 2024 é‹å‹•å™¨è¶…éŸ³æ³¢Lab. All Rights Reserved.</p>
        </div>
    </footer>
</body>
</html>

