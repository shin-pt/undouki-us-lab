<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³¼å…¥å®Œäº† - é‹å‹•å™¨è¶…éŸ³æ³¢Lab</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
        }

        .success-container {
            background: white;
            border-radius: 16px; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
            max-width: 100%; /* ã‚¹ãƒãƒ›ã§ã¯å…¨å¹… */
            width: 100%;
            padding: 30px 20px; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
            text-align: center;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .success-icon {
            font-size: 80px;
            color: #28a745;
            margin-bottom: 30px;
            animation: checkmark 0.6s ease-in-out;
        }

        @keyframes checkmark {
            0% {
                transform: scale(0);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }

        h1 {
            font-size: 1.5rem; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
            color: #333;
            margin-bottom: 15px; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°ã•ã */
            font-weight: 700;
            word-break: keep-all;
            overflow-wrap: break-word;
            padding: 0 10px;
        }

        .message {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 40px;
            line-height: 1.8;
        }

        .video-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: left;
        }

        .video-info h3 {
            color: #333;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .video-info p {
            color: #666;
            margin: 5px 0;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .loading {
            display: none;
            margin: 20px 0;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Responsive Design (Mobile-First) --- */

        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œ (768pxä»¥ä¸Š) */
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }

            .success-container {
                max-width: 600px;
                padding: 60px 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            }

            h1 {
                font-size: 2rem;
                margin-bottom: 20px;
                padding: 0;
            }

            .btn-group {
                flex-direction: row;
            }

            .btn {
                width: auto;
            }
        }

        /* ã‚¹ãƒãƒ›å¯¾å¿œ (767pxæœªæº€) */
        @media (max-width: 767px) {
            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
                padding: 14px 20px;
                min-height: 48px;
                font-size: 0.95rem;
            }
        }
    </style>
</head>
<body>
    <div class="success-container">
        <div class="success-icon">
            <i class="fas fa-check-circle"></i>
        </div>

        <h1>è³¼å…¥ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h1>

        <p class="message">
            å‹•ç”»ã®ã”è³¼å…¥ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<br>
            è³¼å…¥ã•ã‚ŒãŸå‹•ç”»ã®æƒ…å ±ã‚’ç¢ºèªä¸­ã§ã™...
        </p>

        <div id="videoInfo" class="video-info" style="display: none;">
            <h3><i class="fas fa-video"></i> è³¼å…¥å‹•ç”»</h3>
            <p id="videoTitle">å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«</p>
            <p id="videoPrice">ä¾¡æ ¼: Â¥800</p>
        </div>

        <!-- Vimeo Player Section -->
        <div id="vimeoPlayerSection" style="display: none; margin: 30px 0;">
            <h2 style="color: #333; margin-bottom: 20px; font-size: 1.5rem;">
                <i class="fas fa-play-circle"></i> å‹•ç”»ã‚’è¦–è´ã™ã‚‹
            </h2>
            <div id="vimeoPlayerContainer" style="position: relative; padding-bottom: 56.25%; height: 0; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);">
                <!-- Vimeo iframe will be inserted here -->
            </div>
            <p style="margin-top: 15px; color: #666; font-size: 0.95rem;">
                <i class="fas fa-info-circle"></i> ã“ã®å‹•ç”»ã¯è³¼å…¥å¾Œã„ã¤ã§ã‚‚è¦–è´ã§ãã¾ã™
            </p>
        </div>

        <div class="loading active">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #666;">å‡¦ç†ä¸­...</p>
        </div>

        <div class="btn-group" id="actionButtons" style="display: none;">
            <a href="echo-videos.html" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i>
                å‹•ç”»ä¸€è¦§ã«æˆ»ã‚‹
            </a>
            <a href="index.html" class="btn btn-primary">
                <i class="fas fa-home"></i>
                ãƒ›ãƒ¼ãƒ ã¸
            </a>
        </div>

        <p style="margin-top: 30px; color: #999; font-size: 0.9rem;">
            <i class="fas fa-envelope"></i> è³¼å…¥ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ
        </p>
    </div>

    <!-- Video Mapping Data -->
    <script src="vimeo-mapping.js"></script>
    <script src="video-payment-config.js"></script>
    <script src="material-payment-config.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            serverTimestamp,
            query,
            where,
            getDocs
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyAGKikNortFcMI_uLnGn2y_OyI6ZyxLiR0",
            authDomain: "musculoskeletal-us-lab.firebaseapp.com",
            projectId: "musculoskeletal-us-lab",
            storageBucket: "musculoskeletal-us-lab.firebasestorage.app",
            messagingSenderId: "199172067938",
            appId: "1:199172067938:web:cdbcf04400cc74a784b73b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Firestoreã«è³¼å…¥å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°ï¼ˆå‹•ç”»ç”¨ï¼‰
        async function savePurchaseToFirestore(videoId, price, videoTitle) {
            const user = auth.currentUser;
            if (!user) {
                console.warn('âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„ãŸã‚ã€Firestoreã«ä¿å­˜ã§ãã¾ã›ã‚“');
                return;
            }

            try {
                // æ—¢ã«åŒã˜å‹•ç”»ã‚’è³¼å…¥ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const purchasesQuery = query(
                    collection(db, 'purchases'),
                    where('userId', '==', user.uid),
                    where('videoId', '==', videoId)
                );
                const existingPurchases = await getDocs(purchasesQuery);

                if (!existingPurchases.empty) {
                    console.log(`â„¹ï¸ å‹•ç”» ${videoId} ã¯æ—¢ã«è³¼å…¥æ¸ˆã¿ã§ã™`);
                    return;
                }

                // è³¼å…¥å±¥æ­´ã‚’Firestoreã«ä¿å­˜
                await addDoc(collection(db, 'purchases'), {
                    userId: user.uid,
                    videoId: videoId,
                    videoTitle: videoTitle || `å‹•ç”»ID: ${videoId}`,
                    price: price,
                    purchasedAt: serverTimestamp(),
                    type: 'video' // å‹•ç”»è³¼å…¥ã‚’è­˜åˆ¥
                });

                console.log(`âœ… è³¼å…¥å±¥æ­´ã‚’Firestoreã«ä¿å­˜ã—ã¾ã—ãŸ: ${videoId}`);
            } catch (error) {
                console.error('âŒ Firestoreã¸ã®ä¿å­˜ã«å¤±æ•—:', error);
            }
        }

        // Firestoreã«PDFè³¼å…¥å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
        async function saveMaterialPurchaseToFirestore(materialId, price, materialTitle) {
            const user = auth.currentUser;
            if (!user) {
                console.warn('âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„ãŸã‚ã€Firestoreã«ä¿å­˜ã§ãã¾ã›ã‚“');
                return;
            }

            try {
                // æ—¢ã«åŒã˜è³‡æ–™ã‚’è³¼å…¥ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const purchasesQuery = query(
                    collection(db, 'purchases'),
                    where('userId', '==', user.uid),
                    where('materialId', '==', materialId),
                    where('type', '==', 'material')
                );
                const existingPurchases = await getDocs(purchasesQuery);

                if (!existingPurchases.empty) {
                    console.log(`â„¹ï¸ è³‡æ–™ ${materialId} ã¯æ—¢ã«è³¼å…¥æ¸ˆã¿ã§ã™`);
                    return;
                }

                // è³¼å…¥å±¥æ­´ã‚’Firestoreã«ä¿å­˜
                await addDoc(collection(db, 'purchases'), {
                    userId: user.uid,
                    materialId: materialId,
                    materialTitle: materialTitle || `è³‡æ–™ID: ${materialId}`,
                    price: price,
                    purchasedAt: serverTimestamp(),
                    type: 'material' // PDFè³‡æ–™è³¼å…¥ã‚’è­˜åˆ¥
                });

                console.log(`âœ… PDFè³¼å…¥å±¥æ­´ã‚’Firestoreã«ä¿å­˜ã—ã¾ã—ãŸ: ${materialId}`);
            } catch (error) {
                console.error('âŒ Firestoreã¸ã®ä¿å­˜ã«å¤±æ•—:', error);
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆä»–ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ä½¿ç”¨å¯èƒ½ã«ã™ã‚‹ï¼‰
        window.savePurchaseToFirestore = savePurchaseToFirestore;
        window.saveMaterialPurchaseToFirestore = saveMaterialPurchaseToFirestore;
        window.firebaseAuth = auth;
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ’³ Processing payment success...');

            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æƒ…å ±ã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const videoId = urlParams.get('video_id');
            const materialId = urlParams.get('material_id');
            const purchaseType = urlParams.get('type'); // 'video' or 'material'
            const sessionId = urlParams.get('session_id');

            console.log('Video ID from URL:', videoId);
            console.log('Material ID from URL:', materialId);
            console.log('Purchase Type:', purchaseType);
            console.log('Session ID:', sessionId);

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤º
            const loading = document.querySelector('.loading');
            const videoInfoDiv = document.getElementById('videoInfo');
            const actionButtons = document.getElementById('actionButtons');

            // å°‘ã—é…å»¶ã•ã›ã¦å‡¦ç†ã‚’å®Ÿè¡Œï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœã®ãŸã‚ï¼‰
            setTimeout(async function() {
                if (materialId && purchaseType === 'material') {
                    // PDFè³‡æ–™è³¼å…¥ã®å‡¦ç†
                    const price = typeof getMaterialPrice === 'function'
                        ? getMaterialPrice(materialId)
                        : 1500;

                    // ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ï¼ˆMATERIAL_TITLESãŒã‚ã‚Œã°ä½¿ç”¨ï¼‰
                    const materialTitle = (typeof MATERIAL_TITLES !== 'undefined' && MATERIAL_TITLES[materialId])
                        ? MATERIAL_TITLES[materialId]
                        : `è³‡æ–™ID: ${materialId}`;

                    // localStorageã«ã‚‚ä¿å­˜ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
                    if (typeof markMaterialAsPurchased === 'function') {
                        markMaterialAsPurchased(materialId);
                        console.log(`âœ… Marked material as purchased (localStorage): ${materialId}`);
                    }

                    // Firestoreã«è³¼å…¥å±¥æ­´ã‚’ä¿å­˜
                    if (typeof window.saveMaterialPurchaseToFirestore === 'function') {
                        await window.saveMaterialPurchaseToFirestore(materialId, price, materialTitle);
                    }

                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
                    document.querySelector('h1').textContent = 'PDFè³‡æ–™ã®è³¼å…¥ãŒå®Œäº†ã—ã¾ã—ãŸï¼';
                    document.querySelector('.message').innerHTML = `
                        PDFè³‡æ–™ã®ã”è³¼å…¥ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<br>
                        è³¼å…¥ã•ã‚ŒãŸè³‡æ–™ã®æƒ…å ±ã‚’ç¢ºèªä¸­ã§ã™...
                    `;

                    // è³‡æ–™æƒ…å ±ã‚’è¡¨ç¤º
                    document.getElementById('videoInfo').innerHTML = `
                        <h3><i class="fas fa-file-pdf"></i> è³¼å…¥è³‡æ–™</h3>
                        <p id="videoTitle">${materialTitle}</p>
                        <p id="videoPrice">ä¾¡æ ¼: Â¥${price}</p>
                        <p style="margin-top: 15px; color: #666;">
                            <i class="fas fa-info-circle"></i> 
                            <a href="materials.html" style="color: #667eea; text-decoration: underline;">
                                è³‡æ–™ä¸€è¦§ãƒšãƒ¼ã‚¸
                            </a>ã‹ã‚‰PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚
                        </p>
                    `;
                    videoInfoDiv.style.display = 'block';

                    // Vimeoãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯éè¡¨ç¤º
                    document.getElementById('vimeoPlayerSection').style.display = 'none';

                    // ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                    const actionButtons = document.getElementById('actionButtons');
                    actionButtons.innerHTML = `
                        <a href="materials.html" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i>
                            è³‡æ–™ä¸€è¦§ã«æˆ»ã‚‹
                        </a>
                        <a href="index.html" class="btn btn-primary">
                            <i class="fas fa-home"></i>
                            ãƒ›ãƒ¼ãƒ ã¸
                        </a>
                    `;

                } else if (videoId) {
                    // å‹•ç”»è³¼å…¥ã®å‡¦ç†ï¼ˆæ—¢å­˜ã®å‡¦ç†ï¼‰
                    const price = typeof getVideoPrice === 'function'
                        ? getVideoPrice(videoId)
                        : 800;

                    // ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ï¼ˆVIDEO_TITLESãŒã‚ã‚Œã°ä½¿ç”¨ï¼‰
                    const videoTitle = (typeof VIDEO_TITLES !== 'undefined' && VIDEO_TITLES[videoId])
                        ? VIDEO_TITLES[videoId]
                        : `å‹•ç”»ID: ${videoId}`;

                    // localStorageã«ã‚‚ä¿å­˜ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
                    if (typeof markAsPurchased === 'function') {
                        markAsPurchased(videoId);
                        console.log(`âœ… Marked video as purchased (localStorage): ${videoId}`);
                    }

                    // Firestoreã«è³¼å…¥å±¥æ­´ã‚’ä¿å­˜
                    if (typeof window.savePurchaseToFirestore === 'function') {
                        await window.savePurchaseToFirestore(videoId, price, videoTitle);
                    }

                    document.getElementById('videoTitle').textContent = videoTitle;
                    document.getElementById('videoPrice').textContent = `ä¾¡æ ¼: Â¥${price}`;

                    videoInfoDiv.style.display = 'block';

                    // Vimeoå‹•ç”»ã‚’åŸ‹ã‚è¾¼ã‚€
                    if (typeof VIDEO_VIMEO_URLS !== 'undefined' && VIDEO_VIMEO_URLS[videoId]) {
                        const vimeoUrl = VIDEO_VIMEO_URLS[videoId];
                        const vimeoId = vimeoUrl.split('/').pop(); // Extract ID from URL

                        // Create Vimeo iframe
                        const vimeoPlayerContainer = document.getElementById('vimeoPlayerContainer');
                        vimeoPlayerContainer.innerHTML = `
                            <iframe
                                src="https://player.vimeo.com/video/${vimeoId}?badge=0&autopause=0&player_id=0&app_id=58479"
                                frameborder="0"
                                allow="autoplay; fullscreen; picture-in-picture; clipboard-write"
                                style="position:absolute;top:0;left:0;width:100%;height:100%;"
                                title="${videoTitle}">
                            </iframe>
                        `;

                        // Show Vimeo player section
                        document.getElementById('vimeoPlayerSection').style.display = 'block';
                        console.log(`ğŸ¬ Loaded Vimeo video: ${vimeoId}`);
                    } else {
                        console.warn('âš ï¸ Vimeo URL not found for video:', videoId);
                    }
                } else {
                    console.warn('âš ï¸ No video_id or material_id parameter found in URL');
                    document.getElementById('videoTitle').textContent = 'è³¼å…¥æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
                    videoInfoDiv.style.display = 'block';
                }

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºã«ã—ã¦ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                loading.classList.remove('active');
                actionButtons.style.display = 'flex';

                // ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®è³¼å…¥æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
                try {
                    localStorage.removeItem('pending_video_purchase');
                    localStorage.removeItem('pending_material_purchase');
                    localStorage.removeItem('purchase_timestamp');
                    console.log('ğŸ§¹ Cleared pending purchase data');
                } catch (e) {
                    console.warn('âš ï¸ Failed to clear pending purchase:', e);
                }

            }, 1500); // 1.5ç§’å¾Œã«è¡¨ç¤º

            // Google Analytics ãªã©ã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°è¨­å®šãŒã‚ã‚‹å ´åˆã¯ã“ã“ã«è¿½åŠ 
            // gtag('event', 'purchase', { value: price, currency: 'JPY', transaction_id: sessionId });
        });
    </script>
</body>
</html>
